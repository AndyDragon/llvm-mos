; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt < %s  -O1  -S -loop-versioning-licm -licm -debug-only=loop-versioning-licm -enable-new-pm=0 2>&1 | FileCheck --check-prefix=OLD %s
; RUN: opt < %s -S -passes='default<O1>,function(loop-versioning-licm,loop-mssa(licm))' -debug-only=loop-versioning-licm 2>&1 | FileCheck --check-prefix=NEW %s
; REQUIRES: asserts
;
; Test to confirm loop is a candidate for LoopVersioningLICM.
; It also confirms invariant moved out of loop.
;
define i32 @foo(i32* nocapture %var1, i32* nocapture readnone %var2, i32* nocapture %var3, i32 %itr) #0 {
; OLD-LABEL: @foo(
; OLD-NEXT:  entry:
; OLD-NEXT:    [[CMP14:%.*]] = icmp eq i32 [[ITR:%.*]], 0
; OLD-NEXT:    br i1 [[CMP14]], label [[FOR_END13:%.*]], label [[FOR_COND1_PREHEADER_PREHEADER:%.*]]
; OLD:       for.cond1.preheader.preheader:
; OLD-NEXT:    [[SCEVGEP3:%.*]] = getelementptr i32, i32* [[VAR1:%.*]], i64 1
; OLD-NEXT:    [[TMP0:%.*]] = add i32 [[ITR]], -1
; OLD-NEXT:    br label [[FOR_COND1_PREHEADER:%.*]]
; OLD:       for.cond1.preheader:
; OLD-NEXT:    [[INDVAR:%.*]] = phi i64 [ 0, [[FOR_COND1_PREHEADER_PREHEADER]] ], [ [[INDVAR_NEXT:%.*]], [[FOR_INC11:%.*]] ]
; OLD-NEXT:    [[J_016:%.*]] = phi i32 [ [[J_1_LCSSA:%.*]], [[FOR_INC11]] ], [ 0, [[FOR_COND1_PREHEADER_PREHEADER]] ]
; OLD-NEXT:    [[I_015:%.*]] = phi i32 [ [[INC12:%.*]], [[FOR_INC11]] ], [ 0, [[FOR_COND1_PREHEADER_PREHEADER]] ]
; OLD-NEXT:    [[SCEVGEP6:%.*]] = getelementptr i32, i32* [[VAR3:%.*]], i64 [[INDVAR]]
; OLD-NEXT:    [[SCEVGEP67:%.*]] = bitcast i32* [[SCEVGEP6]] to i8*
; OLD-NEXT:    [[TMP1:%.*]] = add i64 [[INDVAR]], 1
; OLD-NEXT:    [[SCEVGEP8:%.*]] = getelementptr i32, i32* [[VAR3]], i64 [[TMP1]]
; OLD-NEXT:    [[SCEVGEP89:%.*]] = bitcast i32* [[SCEVGEP8]] to i8*
; OLD-NEXT:    [[CMP212:%.*]] = icmp ult i32 [[J_016]], [[ITR]]
; OLD-NEXT:    br i1 [[CMP212]], label [[FOR_BODY3_LVER_CHECK:%.*]], label [[FOR_INC11]]
; OLD:       for.body3.lver.check:
; OLD-NEXT:    [[ADD:%.*]] = add i32 [[I_015]], [[ITR]]
; OLD-NEXT:    [[IDXPROM6:%.*]] = zext i32 [[I_015]] to i64
; OLD-NEXT:    [[ARRAYIDX7:%.*]] = getelementptr inbounds i32, i32* [[VAR3]], i64 [[IDXPROM6]]
; OLD-NEXT:    [[TMP2:%.*]] = zext i32 [[J_016]] to i64
; OLD-NEXT:    [[SCEVGEP:%.*]] = getelementptr i32, i32* [[VAR1]], i64 [[TMP2]]
; OLD-NEXT:    [[SCEVGEP2:%.*]] = bitcast i32* [[SCEVGEP]] to i8*
; OLD-NEXT:    [[TMP3:%.*]] = sub i32 [[TMP0]], [[J_016]]
; OLD-NEXT:    [[TMP4:%.*]] = zext i32 [[TMP3]] to i64
; OLD-NEXT:    [[TMP5:%.*]] = add i64 [[TMP2]], [[TMP4]]
; OLD-NEXT:    [[SCEVGEP4:%.*]] = getelementptr i32, i32* [[SCEVGEP3]], i64 [[TMP5]]
; OLD-NEXT:    [[SCEVGEP45:%.*]] = bitcast i32* [[SCEVGEP4]] to i8*
; OLD-NEXT:    [[BOUND0:%.*]] = icmp ult i8* [[SCEVGEP2]], [[SCEVGEP89]]
; OLD-NEXT:    [[BOUND1:%.*]] = icmp ult i8* [[SCEVGEP67]], [[SCEVGEP45]]
; OLD-NEXT:    [[FOUND_CONFLICT:%.*]] = and i1 [[BOUND0]], [[BOUND1]]
; OLD-NEXT:    [[MEMCHECK_CONFLICT:%.*]] = and i1 [[FOUND_CONFLICT]], true
; OLD-NEXT:    br i1 [[MEMCHECK_CONFLICT]], label [[FOR_BODY3_PH_LVER_ORIG:%.*]], label [[FOR_BODY3_PH:%.*]]
; OLD:       for.body3.ph.lver.orig:
; OLD-NEXT:    br label [[FOR_BODY3_LVER_ORIG:%.*]]
; OLD:       for.body3.lver.orig:
; OLD-NEXT:    [[J_113_LVER_ORIG:%.*]] = phi i32 [ [[J_016]], [[FOR_BODY3_PH_LVER_ORIG]] ], [ [[INC_LVER_ORIG:%.*]], [[FOR_BODY3_LVER_ORIG]] ]
; OLD-NEXT:    [[IDXPROM_LVER_ORIG:%.*]] = zext i32 [[J_113_LVER_ORIG]] to i64
; OLD-NEXT:    [[ARRAYIDX_LVER_ORIG:%.*]] = getelementptr inbounds i32, i32* [[VAR1]], i64 [[IDXPROM_LVER_ORIG]]
; OLD-NEXT:    store i32 [[ADD]], i32* [[ARRAYIDX_LVER_ORIG]], align 4
; OLD-NEXT:    [[TMP6:%.*]] = load i32, i32* [[ARRAYIDX7]], align 4
; OLD-NEXT:    [[ADD8_LVER_ORIG:%.*]] = add nsw i32 [[TMP6]], [[ADD]]
; OLD-NEXT:    store i32 [[ADD8_LVER_ORIG]], i32* [[ARRAYIDX7]], align 4
; OLD-NEXT:    [[INC_LVER_ORIG]] = add nuw i32 [[J_113_LVER_ORIG]], 1
; OLD-NEXT:    [[EXITCOND_NOT_LVER_ORIG:%.*]] = icmp eq i32 [[INC_LVER_ORIG]], [[ITR]]
; OLD-NEXT:    br i1 [[EXITCOND_NOT_LVER_ORIG]], label [[FOR_INC11_LOOPEXIT_LOOPEXIT:%.*]], label [[FOR_BODY3_LVER_ORIG]], !llvm.loop [[LOOP0:![0-9]+]]
; OLD:       for.body3.ph:
; OLD-NEXT:    [[ARRAYIDX7_PROMOTED:%.*]] = load i32, i32* [[ARRAYIDX7]], align 4, !alias.scope !2, !noalias !2
; OLD-NEXT:    br label [[FOR_BODY3:%.*]]
; OLD:       for.body3:
; OLD-NEXT:    [[ADD812:%.*]] = phi i32 [ [[ARRAYIDX7_PROMOTED]], [[FOR_BODY3_PH]] ], [ [[ADD8:%.*]], [[FOR_BODY3]] ]
; OLD-NEXT:    [[J_113:%.*]] = phi i32 [ [[J_016]], [[FOR_BODY3_PH]] ], [ [[INC:%.*]], [[FOR_BODY3]] ]
; OLD-NEXT:    [[IDXPROM:%.*]] = zext i32 [[J_113]] to i64
; OLD-NEXT:    [[ARRAYIDX:%.*]] = getelementptr inbounds i32, i32* [[VAR1]], i64 [[IDXPROM]]
; OLD-NEXT:    store i32 [[ADD]], i32* [[ARRAYIDX]], align 4, !alias.scope !2, !noalias !2
; OLD-NEXT:    [[ADD8]] = add nsw i32 [[ADD812]], [[ADD]]
; OLD-NEXT:    [[INC]] = add nuw i32 [[J_113]], 1
; OLD-NEXT:    [[EXITCOND_NOT:%.*]] = icmp eq i32 [[INC]], [[ITR]]
; OLD-NEXT:    br i1 [[EXITCOND_NOT]], label [[FOR_INC11_LOOPEXIT_LOOPEXIT10:%.*]], label [[FOR_BODY3]], !llvm.loop [[LOOP5:![0-9]+]]
; OLD:       for.inc11.loopexit.loopexit:
; OLD-NEXT:    [[J_1_LCSSA_PH_PH:%.*]] = phi i32 [ [[ITR]], [[FOR_BODY3_LVER_ORIG]] ]
; OLD-NEXT:    br label [[FOR_INC11_LOOPEXIT:%.*]]
; OLD:       for.inc11.loopexit.loopexit10:
; OLD-NEXT:    [[ADD8_LCSSA:%.*]] = phi i32 [ [[ADD8]], [[FOR_BODY3]] ]
; OLD-NEXT:    [[J_1_LCSSA_PH_PH11:%.*]] = phi i32 [ [[ITR]], [[FOR_BODY3]] ]
; OLD-NEXT:    store i32 [[ADD8_LCSSA]], i32* [[ARRAYIDX7]], align 4, !alias.scope !2, !noalias !2
; OLD-NEXT:    br label [[FOR_INC11_LOOPEXIT]]
; OLD:       for.inc11.loopexit:
; OLD-NEXT:    [[J_1_LCSSA_PH:%.*]] = phi i32 [ [[J_1_LCSSA_PH_PH]], [[FOR_INC11_LOOPEXIT_LOOPEXIT]] ], [ [[J_1_LCSSA_PH_PH11]], [[FOR_INC11_LOOPEXIT_LOOPEXIT10]] ]
; OLD-NEXT:    br label [[FOR_INC11]]
; OLD:       for.inc11:
; OLD-NEXT:    [[J_1_LCSSA]] = phi i32 [ [[J_016]], [[FOR_COND1_PREHEADER]] ], [ [[J_1_LCSSA_PH]], [[FOR_INC11_LOOPEXIT]] ]
; OLD-NEXT:    [[INC12]] = add nuw i32 [[I_015]], 1
; OLD-NEXT:    [[EXITCOND1_NOT:%.*]] = icmp eq i32 [[INC12]], [[ITR]]
; OLD-NEXT:    [[INDVAR_NEXT]] = add i64 [[INDVAR]], 1
; OLD-NEXT:    br i1 [[EXITCOND1_NOT]], label [[FOR_END13_LOOPEXIT:%.*]], label [[FOR_COND1_PREHEADER]]
; OLD:       for.end13.loopexit:
; OLD-NEXT:    br label [[FOR_END13]]
; OLD:       for.end13:
; OLD-NEXT:    ret i32 0
;
; NEW-LABEL: @foo(
; NEW-NEXT:  entry:
; NEW-NEXT:    [[CMP14:%.*]] = icmp eq i32 [[ITR:%.*]], 0
; NEW-NEXT:    br i1 [[CMP14]], label [[FOR_END13:%.*]], label [[FOR_COND1_PREHEADER_PREHEADER:%.*]]
; NEW:       for.cond1.preheader.preheader:
; NEW-NEXT:    [[SCEVGEP3:%.*]] = getelementptr i32, i32* [[VAR1:%.*]], i64 1
; NEW-NEXT:    [[TMP0:%.*]] = add i32 [[ITR]], -1
; NEW-NEXT:    br label [[FOR_COND1_PREHEADER:%.*]]
; NEW:       for.cond1.preheader:
; NEW-NEXT:    [[INDVAR:%.*]] = phi i64 [ 0, [[FOR_COND1_PREHEADER_PREHEADER]] ], [ [[INDVAR_NEXT:%.*]], [[FOR_INC11:%.*]] ]
; NEW-NEXT:    [[J_016:%.*]] = phi i32 [ [[J_1_LCSSA:%.*]], [[FOR_INC11]] ], [ 0, [[FOR_COND1_PREHEADER_PREHEADER]] ]
; NEW-NEXT:    [[I_015:%.*]] = phi i32 [ [[INC12:%.*]], [[FOR_INC11]] ], [ 0, [[FOR_COND1_PREHEADER_PREHEADER]] ]
; NEW-NEXT:    [[SCEVGEP6:%.*]] = getelementptr i32, i32* [[VAR3:%.*]], i64 [[INDVAR]]
; NEW-NEXT:    [[SCEVGEP67:%.*]] = bitcast i32* [[SCEVGEP6]] to i8*
; NEW-NEXT:    [[TMP1:%.*]] = add i64 [[INDVAR]], 1
; NEW-NEXT:    [[SCEVGEP8:%.*]] = getelementptr i32, i32* [[VAR3]], i64 [[TMP1]]
; NEW-NEXT:    [[SCEVGEP89:%.*]] = bitcast i32* [[SCEVGEP8]] to i8*
; NEW-NEXT:    [[CMP212:%.*]] = icmp ult i32 [[J_016]], [[ITR]]
; NEW-NEXT:    br i1 [[CMP212]], label [[FOR_BODY3_LVER_CHECK:%.*]], label [[FOR_INC11]]
; NEW:       for.body3.lver.check:
; NEW-NEXT:    [[ADD:%.*]] = add i32 [[I_015]], [[ITR]]
; NEW-NEXT:    [[IDXPROM6:%.*]] = zext i32 [[I_015]] to i64
; NEW-NEXT:    [[ARRAYIDX7:%.*]] = getelementptr inbounds i32, i32* [[VAR3]], i64 [[IDXPROM6]]
; NEW-NEXT:    [[TMP2:%.*]] = zext i32 [[J_016]] to i64
; NEW-NEXT:    [[SCEVGEP:%.*]] = getelementptr i32, i32* [[VAR1]], i64 [[TMP2]]
; NEW-NEXT:    [[SCEVGEP2:%.*]] = bitcast i32* [[SCEVGEP]] to i8*
; NEW-NEXT:    [[TMP3:%.*]] = sub i32 [[TMP0]], [[J_016]]
; NEW-NEXT:    [[TMP4:%.*]] = zext i32 [[TMP3]] to i64
; NEW-NEXT:    [[TMP5:%.*]] = add i64 [[TMP2]], [[TMP4]]
; NEW-NEXT:    [[SCEVGEP4:%.*]] = getelementptr i32, i32* [[SCEVGEP3]], i64 [[TMP5]]
; NEW-NEXT:    [[SCEVGEP45:%.*]] = bitcast i32* [[SCEVGEP4]] to i8*
; NEW-NEXT:    [[BOUND0:%.*]] = icmp ult i8* [[SCEVGEP2]], [[SCEVGEP89]]
; NEW-NEXT:    [[BOUND1:%.*]] = icmp ult i8* [[SCEVGEP67]], [[SCEVGEP45]]
; NEW-NEXT:    [[FOUND_CONFLICT:%.*]] = and i1 [[BOUND0]], [[BOUND1]]
; NEW-NEXT:    [[MEMCHECK_CONFLICT:%.*]] = and i1 [[FOUND_CONFLICT]], true
; NEW-NEXT:    br i1 [[MEMCHECK_CONFLICT]], label [[FOR_BODY3_PH_LVER_ORIG:%.*]], label [[FOR_BODY3_PH:%.*]]
; NEW:       for.body3.ph.lver.orig:
; NEW-NEXT:    br label [[FOR_BODY3_LVER_ORIG:%.*]]
; NEW:       for.body3.lver.orig:
; NEW-NEXT:    [[J_113_LVER_ORIG:%.*]] = phi i32 [ [[J_016]], [[FOR_BODY3_PH_LVER_ORIG]] ], [ [[INC_LVER_ORIG:%.*]], [[FOR_BODY3_LVER_ORIG]] ]
; NEW-NEXT:    [[IDXPROM_LVER_ORIG:%.*]] = zext i32 [[J_113_LVER_ORIG]] to i64
; NEW-NEXT:    [[ARRAYIDX_LVER_ORIG:%.*]] = getelementptr inbounds i32, i32* [[VAR1]], i64 [[IDXPROM_LVER_ORIG]]
; NEW-NEXT:    store i32 [[ADD]], i32* [[ARRAYIDX_LVER_ORIG]], align 4
; NEW-NEXT:    [[TMP6:%.*]] = load i32, i32* [[ARRAYIDX7]], align 4
; NEW-NEXT:    [[ADD8_LVER_ORIG:%.*]] = add nsw i32 [[TMP6]], [[ADD]]
; NEW-NEXT:    store i32 [[ADD8_LVER_ORIG]], i32* [[ARRAYIDX7]], align 4
; NEW-NEXT:    [[INC_LVER_ORIG]] = add nuw i32 [[J_113_LVER_ORIG]], 1
; NEW-NEXT:    [[EXITCOND_NOT_LVER_ORIG:%.*]] = icmp eq i32 [[INC_LVER_ORIG]], [[ITR]]
; NEW-NEXT:    br i1 [[EXITCOND_NOT_LVER_ORIG]], label [[FOR_INC11_LOOPEXIT_LOOPEXIT:%.*]], label [[FOR_BODY3_LVER_ORIG]], !llvm.loop [[LOOP0:![0-9]+]]
; NEW:       for.body3.ph:
; NEW-NEXT:    [[ARRAYIDX7_PROMOTED:%.*]] = load i32, i32* [[ARRAYIDX7]], align 4, !alias.scope !2, !noalias !2
; NEW-NEXT:    br label [[FOR_BODY3:%.*]]
; NEW:       for.body3:
; NEW-NEXT:    [[ADD811:%.*]] = phi i32 [ [[ARRAYIDX7_PROMOTED]], [[FOR_BODY3_PH]] ], [ [[ADD8:%.*]], [[FOR_BODY3]] ]
; NEW-NEXT:    [[J_113:%.*]] = phi i32 [ [[J_016]], [[FOR_BODY3_PH]] ], [ [[INC:%.*]], [[FOR_BODY3]] ]
; NEW-NEXT:    [[IDXPROM:%.*]] = zext i32 [[J_113]] to i64
; NEW-NEXT:    [[ARRAYIDX:%.*]] = getelementptr inbounds i32, i32* [[VAR1]], i64 [[IDXPROM]]
; NEW-NEXT:    store i32 [[ADD]], i32* [[ARRAYIDX]], align 4, !alias.scope !2, !noalias !2
; NEW-NEXT:    [[ADD8]] = add nsw i32 [[ADD811]], [[ADD]]
; NEW-NEXT:    [[INC]] = add nuw i32 [[J_113]], 1
; NEW-NEXT:    [[EXITCOND_NOT:%.*]] = icmp eq i32 [[INC]], [[ITR]]
; NEW-NEXT:    br i1 [[EXITCOND_NOT]], label [[FOR_INC11_LOOPEXIT_LOOPEXIT10:%.*]], label [[FOR_BODY3]], !llvm.loop [[LOOP5:![0-9]+]]
; NEW:       for.inc11.loopexit.loopexit:
; NEW-NEXT:    br label [[FOR_INC11_LOOPEXIT:%.*]]
; NEW:       for.inc11.loopexit.loopexit10:
; NEW-NEXT:    [[ADD8_LCSSA:%.*]] = phi i32 [ [[ADD8]], [[FOR_BODY3]] ]
; NEW-NEXT:    store i32 [[ADD8_LCSSA]], i32* [[ARRAYIDX7]], align 4, !alias.scope !2, !noalias !2
; NEW-NEXT:    br label [[FOR_INC11_LOOPEXIT]]
; NEW:       for.inc11.loopexit:
; NEW-NEXT:    br label [[FOR_INC11]]
; NEW:       for.inc11:
; NEW-NEXT:    [[J_1_LCSSA]] = phi i32 [ [[J_016]], [[FOR_COND1_PREHEADER]] ], [ [[ITR]], [[FOR_INC11_LOOPEXIT]] ]
; NEW-NEXT:    [[INC12]] = add nuw i32 [[I_015]], 1
; NEW-NEXT:    [[EXITCOND1_NOT:%.*]] = icmp eq i32 [[INC12]], [[ITR]]
; NEW-NEXT:    [[INDVAR_NEXT]] = add i64 [[INDVAR]], 1
; NEW-NEXT:    br i1 [[EXITCOND1_NOT]], label [[FOR_END13_LOOPEXIT:%.*]], label [[FOR_COND1_PREHEADER]]
; NEW:       for.end13.loopexit:
; NEW-NEXT:    br label [[FOR_END13]]
; NEW:       for.end13:
; NEW-NEXT:    ret i32 0
;
entry:
  %cmp14 = icmp eq i32 %itr, 0
  br i1 %cmp14, label %for.end13, label %for.cond1.preheader.preheader

for.cond1.preheader.preheader:                    ; preds = %entry
  br label %for.cond1.preheader

for.cond1.preheader:                              ; preds = %for.cond1.preheader.preheader, %for.inc11
  %j.016 = phi i32 [ %j.1.lcssa, %for.inc11 ], [ 0, %for.cond1.preheader.preheader ]
  %i.015 = phi i32 [ %inc12, %for.inc11 ], [ 0, %for.cond1.preheader.preheader ]
  %cmp212 = icmp ult i32 %j.016, %itr
  br i1 %cmp212, label %for.body3.lr.ph, label %for.inc11

for.body3.lr.ph:                                  ; preds = %for.cond1.preheader
  %add = add i32 %i.015, %itr
  %idxprom6 = zext i32 %i.015 to i64
  %arrayidx7 = getelementptr inbounds i32, i32* %var3, i64 %idxprom6
  br label %for.body3

for.body3:                                        ; preds = %for.body3.lr.ph, %for.body3
  %j.113 = phi i32 [ %j.016, %for.body3.lr.ph ], [ %inc, %for.body3 ]
  %idxprom = zext i32 %j.113 to i64
  %arrayidx = getelementptr inbounds i32, i32* %var1, i64 %idxprom
  store i32 %add, i32* %arrayidx, align 4
  %0 = load i32, i32* %arrayidx7, align 4
  %add8 = add nsw i32 %0, %add
  store i32 %add8, i32* %arrayidx7, align 4
  %inc = add nuw i32 %j.113, 1
  %cmp2 = icmp ult i32 %inc, %itr
  br i1 %cmp2, label %for.body3, label %for.inc11.loopexit

for.inc11.loopexit:                               ; preds = %for.body3
  br label %for.inc11

for.inc11:                                        ; preds = %for.inc11.loopexit, %for.cond1.preheader
  %j.1.lcssa = phi i32 [ %j.016, %for.cond1.preheader ], [ %itr, %for.inc11.loopexit ]
  %inc12 = add nuw i32 %i.015, 1
  %cmp = icmp ult i32 %inc12, %itr
  br i1 %cmp, label %for.cond1.preheader, label %for.end13.loopexit

for.end13.loopexit:                               ; preds = %for.inc11
  br label %for.end13

for.end13:                                        ; preds = %for.end13.loopexit, %entry
  ret i32 0
}

